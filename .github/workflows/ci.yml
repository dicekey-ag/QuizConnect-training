name: Docker Compose CI

# on:
#   pull_request:
#     branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Docker Compose
      run: |
        sudo curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
        sudo chmod +x /usr/local/bin/docker-compose

    - name: Create .env file
      run: |
        echo "DB_HOST=${{ secrets.DB_HOST }}" > ./.env
        echo "DB_USER=${{ secrets.DB_USER }}" >> ./.env
        echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> ./.env
        echo "DB_NAME=${{ secrets.DB_NAME }}" >> ./.env
        echo "DB_PORT=${{ secrets.DB_PORT }}" >> ./.env
        echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> ./.env
        echo "TEST_DB_NAME=${{ secrets.TEST_DB_NAME }}" >> ./.env
        echo "NODE_ENV=test" >> ./.env
        echo "MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}" >> ./.env

    - name: Debug - Show .env file content (masked)
      run: sed 's/=.*$/=****/' ./.env

    - name: Build Docker images
      run: docker-compose -f docker-compose.ci.yml build

    - name: Start Docker containers
      run: docker-compose -f docker-compose.ci.yml up -d

    - name: Wait for database to be ready
      run: |
        docker-compose -f docker-compose.ci.yml exec -T db sh -c '
        for i in `seq 1 30`; do
          if mysqladmin ping -h"$MYSQL_HOST" -u"$MYSQL_USER" -p"$MYSQL_PASSWORD" --silent; then
            echo "Database is ready!"
            exit 0
          fi
          echo "Waiting for database..."
          sleep 1
        done
        echo "Database did not become ready in time."
        exit 1
        '

    - name: Debug - Show environment variables
      run: |
        docker-compose -f docker-compose.ci.yml exec -T backend env

    - name: Check network connectivity
      run: |
        docker-compose -f docker-compose.ci.yml exec -T backend ping -c 4 db

    - name: Check database connection
      run: |
        docker-compose -f docker-compose.ci.yml exec -T backend node -e "
        const mysql = require('mysql2/promise');
        async function checkConnection() {
          try {
            const connection = await mysql.createConnection({
              host: process.env.DB_HOST,
              user: process.env.DB_USER,
              password: process.env.DB_PASSWORD,
              database: process.env.TEST_DB_NAME,
              port: process.env.DB_PORT
            });
            console.log('Database connection successful');
            await connection.end();
          } catch (err) {
            console.error('Database connection failed:', err);
            process.exit(1);
          }
        }
        checkConnection();
        "

    - name: Run migrations
      run: |
        docker-compose -f docker-compose.ci.yml exec -T backend npx sequelize-cli db:migrate --env test --verbose

    - name: Display logs
      if: failure()
      run: |
        docker-compose -f docker-compose.ci.yml logs

    - name: Run backend tests
      run: |
        docker-compose -f docker-compose.ci.yml exec -T backend npm run test -- --verbose

    - name: Display test results
      if: always()
      run: |
        docker-compose -f docker-compose.ci.yml exec -T backend cat coverage/lcov-report/index.html || true

    - name: Upload test coverage
      if: always()
      uses: actions/upload-artifact@v2
      with:
        name: coverage-report
        path: backend/coverage

    - name: Stop containers
      if: always()
      run: docker-compose -f docker-compose.ci.yml down
